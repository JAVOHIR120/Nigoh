<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nigoh | Professional Admin Dashboard</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    
    <style>
        /* --- 1. CORE VARIABLES & RESET --- */
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --secondary: #64748b;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark-bg: #0f172a;
            --panel-bg: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border-color: rgba(255, 255, 255, 0.08);
            --glass-bg: rgba(30, 41, 59, 0.7);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        
        body {
            background-color: var(--dark-bg);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            overflow-x: hidden;
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--dark-bg); }
        ::-webkit-scrollbar-thumb { background: var(--secondary); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* --- 2. SIDEBAR STYLING --- */
        .sidebar {
            width: 280px;
            background: var(--panel-bg);
            border-right: 1px solid var(--border-color);
            height: 100vh;
            position: fixed;
            top: 0; left: 0;
            display: flex;
            flex-direction: column;
            z-index: 1000;
            transition: var(--transition);
        }

        .sidebar-header {
            padding: 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        .brand-icon {
            width: 40px; height: 40px;
            background: linear-gradient(135deg, var(--primary), #8b5cf6);
            border-radius: 10px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
        }

        .brand-text { font-size: 1.5rem; font-weight: 700; letter-spacing: -0.5px; color: white; }

        .nav-menu { padding: 24px 16px; flex: 1; overflow-y: auto; }
        
        .nav-item {
            display: flex; align-items: center; gap: 12px;
            padding: 14px 16px;
            color: var(--text-muted);
            text-decoration: none;
            border-radius: 12px;
            margin-bottom: 8px;
            font-weight: 500;
            transition: var(--transition);
            cursor: pointer;
            border: 1px solid transparent;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary);
            border-color: rgba(59, 130, 246, 0.2);
        }
        
        .nav-item i { width: 20px; text-align: center; }

        .user-profile {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex; align-items: center; gap: 12px;
            background: rgba(0,0,0,0.2);
        }
        
        .avatar-circle {
            width: 40px; height: 40px;
            border-radius: 50%;
            background: var(--secondary);
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; color: white;
            flex-shrink: 0;
        }
        .user-info { overflow: hidden; }
        .user-info h4 { font-size: 0.9rem; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }
        .user-info p { font-size: 0.75rem; color: var(--text-muted); }

        /* --- 3. MAIN CONTENT --- */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 30px;
            transition: var(--transition);
            width: calc(100% - 280px);
        }

        /* Top Bar */
        .top-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap; gap: 20px;
        }
        
        .page-title h1 { font-size: 1.8rem; font-weight: 700; color: white; }
        .page-title p { color: var(--text-muted); font-size: 0.9rem; margin-top: 5px; }

        .top-actions { display: flex; gap: 15px; align-items: center; }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            display: flex; align-items: center; gap: 8px;
            transition: var(--transition);
            font-size: 0.9rem;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3); }
        .btn-outline { background: transparent; border: 1px solid var(--border-color); color: var(--text-main); }
        .btn-outline:hover { border-color: var(--primary); color: var(--primary); }
        .btn-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.2); }
        .btn-danger:hover { background: var(--danger); color: white; }

        /* --- 4. STATS CARDS --- */
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 24px; margin-bottom: 30px;
        }

        .stat-card {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            padding: 24px;
            border-radius: 16px;
            position: relative;
            overflow: hidden;
            transition: var(--transition);
        }

        .stat-card:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: var(--shadow); }
        
        .stat-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px; }
        .stat-icon {
            width: 48px; height: 48px;
            border-radius: 12px;
            background: rgba(59, 130, 246, 0.1);
            color: var(--primary);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem;
        }
        .stat-value { font-size: 2.2rem; font-weight: 700; color: white; }
        .stat-label { color: var(--text-muted); font-size: 0.9rem; }
        
        /* --- 5. CHARTS SECTION --- */
        .charts-container {
            display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 30px;
        }
        
        .chart-box {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            padding: 24px;
            border-radius: 16px;
            height: 400px;
            position: relative;
        }

        /* --- 6. DATA TABLE & FILTERS --- */
        .table-section {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            overflow: hidden;
        }

        .table-controls {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
            flex-wrap: wrap; gap: 15px;
        }

        .search-wrapper { position: relative; width: 300px; max-width: 100%; }
        .search-wrapper i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
        .search-input {
            width: 100%; padding: 12px 12px 12px 40px;
            background: var(--dark-bg);
            border: 1px solid var(--border-color);
            border-radius: 10px; color: white;
            outline: none; transition: var(--transition);
        }
        .search-input:focus { border-color: var(--primary); }

        .filter-group { display: flex; gap: 10px; }
        .filter-select {
            padding: 10px 15px; background: var(--dark-bg);
            border: 1px solid var(--border-color);
            color: white; border-radius: 10px; outline: none; cursor: pointer;
        }

        /* Table Responsive */
        .table-responsive { overflow-x: auto; width: 100%; }
        .data-table { width: 100%; border-collapse: collapse; min-width: 900px; }
        
        .data-table th, .data-table td {
            padding: 16px 20px; text-align: left;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-muted); font-size: 0.95rem;
        }
        .data-table th {
            background: rgba(15, 23, 42, 0.5);
            color: white; font-weight: 600; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px;
            cursor: pointer; user-select: none;
        }
        .data-table th:hover { color: var(--primary); }
        .data-table tr:hover { background: rgba(255,255,255,0.02); }
        
        .user-cell { display: flex; align-items: center; gap: 10px; color: white; font-weight: 500; }
        .user-avatar-sm { width: 32px; height: 32px; background: var(--secondary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; color: white; }
        
        /* Status Badges */
        .badge { padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; }
        .badge-new { background: rgba(245, 158, 11, 0.1); color: var(--warning); border: 1px solid rgba(245, 158, 11, 0.2); }
        .badge-solved { background: rgba(16, 185, 129, 0.1); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.2); }
        .badge-rejected { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.2); }

        /* Actions */
        .action-buttons { display: flex; gap: 8px; }
        .btn-icon {
            width: 32px; height: 32px; border-radius: 8px; border: none;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: var(--transition);
        }
        .btn-edit { background: rgba(59, 130, 246, 0.1); color: var(--primary); }
        .btn-edit:hover { background: var(--primary); color: white; }
        .btn-delete-row { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .btn-delete-row:hover { background: var(--danger); color: white; }
        .btn-map { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .btn-map:hover { background: var(--success); color: white; }

        /* Pagination */
        .pagination {
            padding: 20px; border-top: 1px solid var(--border-color);
            display: flex; justify-content: space-between; align-items: center;
        }
        .page-info { color: var(--text-muted); font-size: 0.9rem; }
        .page-buttons { display: flex; gap: 5px; }
        .page-btn {
            width: 36px; height: 36px; border-radius: 8px; border: 1px solid var(--border-color);
            background: var(--dark-bg); color: var(--text-muted);
            cursor: pointer; transition: var(--transition);
        }
        .page-btn:hover, .page-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* --- 7. MODALS --- */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(5px);
            z-index: 2000; display: none; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s ease;
        }
        .modal-backdrop.show { opacity: 1; }
        
        .modal-panel {
            background: var(--panel-bg); border: 1px solid var(--border-color);
            border-radius: 20px; width: 90%; max-width: 500px;
            padding: 30px; position: relative;
            transform: scale(0.9); transition: transform 0.3s ease;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        .modal-backdrop.show .modal-panel { transform: scale(1); }

        .modal-icon {
            width: 60px; height: 60px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.8rem; margin: 0 auto 20px;
        }
        .icon-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .icon-info { background: rgba(59, 130, 246, 0.1); color: var(--primary); }

        .modal-title { text-align: center; font-size: 1.5rem; margin-bottom: 10px; color: white; }
        .modal-text { text-align: center; color: var(--text-muted); margin-bottom: 30px; }
        
        .modal-actions { display: flex; gap: 15px; justify-content: center; }
        .full-btn { width: 100%; justify-content: center; padding: 12px; }

        /* --- 8. MOBILE RESPONSIVE --- */
        .mobile-toggle { display: none; font-size: 1.5rem; color: white; cursor: pointer; }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 40; }

        @media (max-width: 1024px) {
            .charts-container { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); width: 260px; }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; width: 100%; padding: 20px; }
            .mobile-toggle { display: block; }
            .top-bar { gap: 15px; }
            .page-title { display: none; } /* Joyni tejash uchun */
            .sidebar-overlay.active { display: block; }
            .table-controls { flex-direction: column; align-items: stretch; }
            .search-wrapper { width: 100%; }
        }

        /* TOAST */
        .toast-box { position: fixed; top: 20px; right: 20px; z-index: 3000; }
        .toast {
            background: var(--panel-bg); border-left: 4px solid;
            padding: 16px 20px; margin-bottom: 10px; border-radius: 8px;
            display: flex; align-items: center; gap: 15px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
            transform: translateX(100%); animation: slideIn 0.4s forwards;
            min-width: 300px; color: white;
        }
        @keyframes slideIn { to { transform: translateX(0); } }

    </style>
</head>
<body>

    <div class="toast-box" id="toastBox"></div>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="brand-icon"><i class="fa-solid fa-shield-halved"></i></div>
            <div class="brand-text">NIGOH</div>
        </div>
        
        <nav class="nav-menu">
            <div class="nav-item active">
                <i class="fa-solid fa-chart-pie"></i>
                <span>Dashboard</span>
            </div>
            <a href="index.html" class="nav-item">
                <i class="fa-solid fa-globe"></i>
                <span>Saytga O'tish</span>
            </a>
            <div class="nav-item">
                <i class="fa-solid fa-users"></i>
                <span>Foydalanuvchilar</span>
            </div>
            <div class="nav-item">
                <i class="fa-solid fa-gear"></i>
                <span>Sozlamalar</span>
            </div>
        </nav>

        <div class="user-profile">
            <div class="avatar-circle">A</div>
            <div class="user-info">
                <h4 id="adminNameDisplay">Admin</h4>
                <p id="adminEmailDisplay">loading...</p>
            </div>
            <button id="logoutBtn" class="btn-icon" style="margin-left:auto; color:var(--danger)"><i class="fa-solid fa-right-from-bracket"></i></button>
        </div>
    </aside>

    <main class="main-content">
        <div class="top-bar">
            <div style="display:flex; align-items:center; gap:15px;">
                <div class="mobile-toggle" id="menuBtn"><i class="fa-solid fa-bars"></i></div>
                <div class="page-title">
                    <h1>Boshqaruv Paneli</h1>
                    <p>Tizim holati va murojaatlar monitoringi</p>
                </div>
            </div>
            
            <div class="top-actions">
                <button class="btn btn-outline" onclick="loadData()"><i class="fa-solid fa-rotate-right"></i> Yangilash</button>
                <button class="btn btn-primary" onclick="exportToExcel()"><i class="fa-solid fa-file-excel"></i> Excel Export</button>
            </div>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-value" id="totalCount">0</div>
                        <div class="stat-label">Jami Murojaatlar</div>
                    </div>
                    <div class="stat-icon"><i class="fa-solid fa-layer-group"></i></div>
                </div>
                <div style="font-size:0.8rem; color:var(--success);"><i class="fa-solid fa-arrow-trend-up"></i> +12% o'tgan oyga nisbatan</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-value" id="solvedCount" style="color:var(--success)">0</div>
                        <div class="stat-label">Hal Etilgan</div>
                    </div>
                    <div class="stat-icon" style="color:var(--success); background:rgba(16,185,129,0.1)"><i class="fa-solid fa-circle-check"></i></div>
                </div>
                <div class="progress-bar" style="height:4px; background:#334155; margin-top:10px; border-radius:2px;">
                    <div id="solvedProgress" style="width:0%; height:100%; background:var(--success); border-radius:2px; transition:width 1s;"></div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-value" id="pendingCount" style="color:var(--warning)">0</div>
                        <div class="stat-label">Ko'rib Chiqilmoqda</div>
                    </div>
                    <div class="stat-icon" style="color:var(--warning); background:rgba(245,158,11,0.1)"><i class="fa-solid fa-clock"></i></div>
                </div>
                 <div style="font-size:0.8rem; color:var(--warning);">Tezkor reaksiya talab etiladi</div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div>
                        <div class="stat-value" id="rejectedCount" style="color:var(--danger)">0</div>
                        <div class="stat-label">Rad Etilgan</div>
                    </div>
                    <div class="stat-icon" style="color:var(--danger); background:rgba(239,68,68,0.1)"><i class="fa-solid fa-ban"></i></div>
                </div>
            </div>
        </div>

        <div class="charts-container">
            <div class="chart-box">
                <h3 style="margin-bottom:20px; font-size:1.1rem;">Murojaatlar Statistikasi (Oylik)</h3>
                <canvas id="mainChart"></canvas>
            </div>
            <div class="chart-box">
                <h3 style="margin-bottom:20px; font-size:1.1rem;">Kategoriyalar Ulushi</h3>
                <canvas id="pieChart"></canvas>
            </div>
        </div>

        <div class="table-section">
            <div class="table-controls">
                <div class="search-wrapper">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input type="text" id="searchInput" class="search-input" placeholder="Qidirish... (Ism, Manzil, ID)">
                </div>
                
                <div class="filter-group">
                    <select id="statusFilter" class="filter-select">
                        <option value="all">Barcha Statuslar</option>
                        <option value="Yangi">‚è≥ Yangi</option>
                        <option value="Hal etildi">‚úÖ Hal etildi</option>
                        <option value="Rad etildi">üö´ Rad etildi</option>
                    </select>
                    
                    <select id="typeFilter" class="filter-select">
                        <option value="all">Barcha Turlar</option>
                        <option value="Pora olish/berish">Pora</option>
                        <option value="Infratuzilma">Infratuzilma</option>
                        <option value="Vakolat suiiste'moli">Vakolat</option>
                        <option value="O'g'rilik">O'g'rilik</option>
                    </select>
                </div>
            </div>

            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th width="50"><input type="checkbox" id="selectAll"></th>
                            <th onclick="sortTable('date')">Sana <i class="fa-solid fa-sort"></i></th>
                            <th>Foydalanuvchi</th>
                            <th>Muammo Turi</th>
                            <th>Manzil & Tavsif</th>
                            <th onclick="sortTable('status')">Status <i class="fa-solid fa-sort"></i></th>
                            <th>Amallar</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                        </tbody>
                </table>
            </div>

            <div class="pagination">
                <div class="page-info">
                    Namoyish: <span id="showingStart">0</span>-<span id="showingEnd">0</span> / Jami: <span id="totalItems">0</span>
                </div>
                <div class="page-buttons" id="paginationBtns">
                    </div>
            </div>
        </div>
    </main>

    <div class="modal-backdrop" id="deleteModal">
        <div class="modal-panel">
            <div class="modal-icon icon-danger"><i class="fa-solid fa-trash-can"></i></div>
            <h3 class="modal-title">O'chirishni tasdiqlang</h3>
            <p class="modal-text">Siz ushbu murojaatni butunlay o'chirib tashlamoqchisiz. Bu amalni ortga qaytarib bo'lmaydi.</p>
            <div class="modal-actions">
                <button class="btn btn-outline full-btn" onclick="closeModal('deleteModal')">Bekor qilish</button>
                <button class="btn btn-primary full-btn" id="confirmDeleteBtn" style="background:var(--danger)">Ha, O'chirish</button>
            </div>
        </div>
    </div>

    <div class="modal-backdrop" id="editModal">
        <div class="modal-panel">
            <div class="modal-icon icon-info"><i class="fa-solid fa-pen-to-square"></i></div>
            <h3 class="modal-title">Statusni O'zgartirish</h3>
            <p class="modal-text">Murojaat holatini yangilang. Foydalanuvchiga xabar yuboriladi.</p>
            
            <div style="margin-bottom:20px;">
                <label style="display:block; margin-bottom:8px; color:var(--text-muted)">Yangi Status:</label>
                <select id="editStatusSelect" class="filter-select" style="width:100%; padding:12px;">
                    <option value="Yangi">‚è≥ Yangi (Ko'rib chiqilmoqda)</option>
                    <option value="Hal etildi">‚úÖ Hal etildi (Muvaffaqiyatli)</option>
                    <option value="Rad etildi">üö´ Rad etildi (Bekor qilindi)</option>
                </select>
            </div>

            <div class="modal-actions">
                <button class="btn btn-outline full-btn" onclick="closeModal('editModal')">Yopish</button>
                <button class="btn btn-primary full-btn" id="confirmEditBtn">Saqlash</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { auth, db, collection, getDocs, deleteDoc, doc, updateDoc, onAuthStateChanged, signOut } from './firebase-config.js';

        // --- STATE VARIABLES ---
        const ADMIN_EMAIL = "islomovjavohir939@gmail.com";
        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        const itemsPerPage = 8;
        let deleteTargetId = null;
        let editTargetId = null;
        let chartInstance1 = null;
        let chartInstance2 = null;

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Sidebar Toggle (Mobile)
            const menuBtn = document.getElementById('menuBtn');
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            function toggleMenu() {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('active');
            }

            menuBtn.addEventListener('click', toggleMenu);
            overlay.addEventListener('click', toggleMenu);

            // Inputs Event Listeners
            document.getElementById('searchInput').addEventListener('input', filterData);
            document.getElementById('statusFilter').addEventListener('change', filterData);
            document.getElementById('typeFilter').addEventListener('change', filterData);
        });

        // --- AUTH CHECK ---
        onAuthStateChanged(auth, (user) => {
            if (!user || user.email !== ADMIN_EMAIL) {
                window.location.href = "login.html";
            } else {
                document.getElementById('adminNameDisplay').innerText = user.displayName || "Admin";
                document.getElementById('adminEmailDisplay').innerText = user.email;
                fetchData();
            }
        });

        document.getElementById('logoutBtn').onclick = () => {
            signOut(auth).then(() => window.location.href = "login.html");
        };

        // --- DATA FETCHING ---
        async function fetchData() {
            showToast('Yuklanmoqda...', 'Ma\'lumotlar yangilanmoqda', 'info');
            try {
                const querySnapshot = await getDocs(collection(db, "reports"));
                allData = [];
                querySnapshot.forEach((doc) => {
                    allData.push({ id: doc.id, ...doc.data() });
                });
                
                // Sort by Date (Newest first)
                allData.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                filteredData = [...allData];
                updateStats();
                initCharts();
                renderTable();
            } catch (error) {
                console.error(error);
                showToast('Xatolik', 'Ma\'lumotlarni yuklashda xato', 'error');
            }
        }

        // --- FILTERING & SEARCH ---
        function filterData() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const status = document.getElementById('statusFilter').value;
            const type = document.getElementById('typeFilter').value;

            filteredData = allData.filter(item => {
                const matchesSearch = (item.description || "").toLowerCase().includes(search) || 
                                      (item.address || "").toLowerCase().includes(search) || 
                                      (item.email || "").toLowerCase().includes(search);
                const matchesStatus = status === 'all' || item.status === status;
                const matchesType = type === 'all' || item.type === type;

                return matchesSearch && matchesStatus && matchesType;
            });

            currentPage = 1;
            renderTable();
        }

        // --- RENDERING TABLE ---
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            // Pagination Logic
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginatedItems = filteredData.slice(start, end);

            // Update Counts
            document.getElementById('showingStart').innerText = filteredData.length > 0 ? start + 1 : 0;
            document.getElementById('showingEnd').innerText = Math.min(end, filteredData.length);
            document.getElementById('totalItems').innerText = filteredData.length;

            if (paginatedItems.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:30px;">Ma'lumot topilmadi</td></tr>`;
                return;
            }

            paginatedItems.forEach(item => {
                const date = new Date(item.date).toLocaleDateString('uz-UZ');
                let badgeClass = 'badge-new';
                if(item.status === 'Hal etildi') badgeClass = 'badge-solved';
                if(item.status === 'Rad etildi') badgeClass = 'badge-rejected';

                let mapBtn = '';
                if(item.latitude) {
                    mapBtn = `<button class="btn-icon btn-map" title="Xaritada ko'rish" onclick="window.open('http://maps.google.com/?q=${item.latitude},${item.longitude}', '_blank')"><i class="fa-solid fa-map-location-dot"></i></button>`;
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><input type="checkbox" class="row-checkbox"></td>
                    <td style="white-space:nowrap; font-size:0.85rem;">${item.date}</td>
                    <td>
                        <div class="user-cell">
                            <div class="user-avatar-sm">${item.email.charAt(0).toUpperCase()}</div>
                            <div>
                                <div>${item.email.split('@')[0]}</div>
                                <div style="font-size:0.75rem; color:var(--text-muted)">${item.email}</div>
                            </div>
                        </div>
                    </td>
                    <td><span style="font-weight:600; color:var(--primary)">${item.type}</span></td>
                    <td style="max-width:200px;">
                        <div style="font-weight:500">${item.address}</div>
                        <div style="font-size:0.8rem; color:var(--text-muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${item.description}</div>
                    </td>
                    <td><span class="badge ${badgeClass}">${item.status}</span></td>
                    <td>
                        <div class="action-buttons">
                            ${mapBtn}
                            <button class="btn-icon btn-edit" onclick="openEditModal('${item.id}', '${item.status}')"><i class="fa-solid fa-pen"></i></button>
                            <button class="btn-icon btn-delete-row" onclick="openDeleteModal('${item.id}')"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            renderPaginationButtons();
        }

        // --- PAGINATION BUTTONS ---
        function renderPaginationButtons() {
            const container = document.getElementById('paginationBtns');
            container.innerHTML = '';
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);

            for (let i = 1; i <= totalPages; i++) {
                const btn = document.createElement('button');
                btn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
                btn.innerText = i;
                btn.onclick = () => {
                    currentPage = i;
                    renderTable();
                };
                container.appendChild(btn);
            }
        }

        // --- STATS & CHARTS ---
        function updateStats() {
            const total = allData.length;
            const solved = allData.filter(d => d.status === 'Hal etildi').length;
            const pending = allData.filter(d => d.status === 'Yangi').length;
            const rejected = allData.filter(d => d.status === 'Rad etildi').length;

            document.getElementById('totalCount').innerText = total;
            document.getElementById('solvedCount').innerText = solved;
            document.getElementById('pendingCount').innerText = pending;
            document.getElementById('rejectedCount').innerText = rejected;

            // Progress Bar Animation
            setTimeout(() => {
                const percent = total > 0 ? (solved / total) * 100 : 0;
                document.getElementById('solvedProgress').style.width = `${percent}%`;
            }, 500);
        }

        function initCharts() {
            const ctx1 = document.getElementById('mainChart').getContext('2d');
            const ctx2 = document.getElementById('pieChart').getContext('2d');

            // Data Preparation
            const types = {};
            allData.forEach(item => types[item.type] = (types[item.type] || 0) + 1);
            
            const statuses = { 'Yangi': 0, 'Hal etildi': 0, 'Rad etildi': 0 };
            allData.forEach(item => {
                if(statuses[item.status] !== undefined) statuses[item.status]++;
            });

            if(chartInstance1) chartInstance1.destroy();
            if(chartInstance2) chartInstance2.destroy();

            // Line Chart (Trend) - Fake data generator based on real counts for demo visuals
            chartInstance1 = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: Object.keys(types),
                    datasets: [{
                        label: 'Murojaatlar Soni',
                        data: Object.values(types),
                        backgroundColor: '#3b82f6',
                        borderRadius: 6,
                        barThickness: 40
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } },
                        x: { grid: { display: false } }
                    }
                }
            });

            // Doughnut Chart
            chartInstance2 = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statuses),
                    datasets: [{
                        data: Object.values(statuses),
                        backgroundColor: ['#f59e0b', '#10b981', '#ef4444'],
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { 
                        legend: { position: 'bottom', labels: { color: '#94a3b8', padding: 20 } } 
                    },
                    cutout: '70%'
                }
            });
        }

        // --- ACTIONS (DELETE & EDIT) ---
        window.openDeleteModal = (id) => {
            deleteTargetId = id;
            const modal = document.getElementById('deleteModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
        };

        window.openEditModal = (id, currentStatus) => {
            editTargetId = id;
            document.getElementById('editStatusSelect').value = currentStatus;
            const modal = document.getElementById('editModal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
        };

        window.closeModal = (modalId) => {
            const modal = document.getElementById(modalId);
            modal.classList.remove('show');
            setTimeout(() => modal.style.display = 'none', 300);
            deleteTargetId = null;
            editTargetId = null;
        };

        // Confirm Delete
        document.getElementById('confirmDeleteBtn').onclick = async () => {
            if(!deleteTargetId) return;
            try {
                await deleteDoc(doc(db, "reports", deleteTargetId));
                showToast('O\'chirildi', 'Murojaat muvaffaqiyatli o\'chirildi', 'success');
                closeModal('deleteModal');
                fetchData();
            } catch (error) {
                showToast('Xatolik', error.message, 'error');
            }
        };

        // Confirm Edit
        document.getElementById('confirmEditBtn').onclick = async () => {
            if(!editTargetId) return;
            const newStatus = document.getElementById('editStatusSelect').value;
            try {
                await updateDoc(doc(db, "reports", editTargetId), { status: newStatus });
                showToast('Yangilandi', `Status o'zgartirildi: ${newStatus}`, 'success');
                closeModal('editModal');
                fetchData();
            } catch (error) {
                showToast('Xatolik', error.message, 'error');
            }
        };

        // --- EXPORT TO EXCEL ---
        window.exportToExcel = () => {
            if(filteredData.length === 0) return showToast('Diqqat', 'Yuklash uchun ma\'lumot yo\'q', 'warning');
            
            const exportData = filteredData.map(item => ({
                ID: item.id,
                Sana: item.date,
                Foydalanuvchi: item.email,
                Tur: item.type,
                Manzil: item.address,
                Tavsif: item.description,
                Status: item.status,
                Lokatsiya: item.latitude ? `${item.latitude}, ${item.longitude}` : 'Yo\'q'
            }));

            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Hisobot");
            XLSX.writeFile(wb, `Nigoh_Report_${new Date().toISOString().slice(0,10)}.xlsx`);
            showToast('Yuklandi', 'Excel fayl tayyorlandi', 'success');
        };

        // --- UI UTILS ---
        window.sortTable = (field) => {
            // Sort logic implementation can be added here
            // Currently fetching sorts by date by default
            showToast('Info', 'Hozircha faqat sana bo\'yicha avtomatik saralanadi', 'info');
        };

        function showToast(title, message, type) {
            const box = document.getElementById('toastBox');
            const toast = document.createElement('div');
            
            let color = type === 'success' ? '#10b981' : (type === 'error' ? '#ef4444' : '#3b82f6');
            let icon = type === 'success' ? '<i class="fa-solid fa-circle-check"></i>' : (type === 'error' ? '<i class="fa-solid fa-circle-xmark"></i>' : '<i class="fa-solid fa-circle-info"></i>');

            toast.className = 'toast';
            toast.style.borderColor = color;
            toast.innerHTML = `
                <div style="font-size:1.5rem; color:${color}">${icon}</div>
                <div>
                    <h4 style="margin:0; font-size:0.95rem; font-weight:600">${title}</h4>
                    <p style="margin:2px 0 0; font-size:0.85rem; opacity:0.8">${message}</p>
                </div>
            `;
            
            box.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.4s reverse forwards';
                setTimeout(() => toast.remove(), 400);
            }, 3000);
        }
    </script>
</body>
</html>