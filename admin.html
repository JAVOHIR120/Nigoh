<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Nigoh</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    
    <style>
        /* --- RESET & ASOSIY STILLAR --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { background-color: #f1f5f9; color: #1e293b; overflow-x: hidden; }

        /* --- LAYOUT (TU ZILMA) --- */
        .admin-wrapper {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar (Chap menyu) */
        .sidebar {
            width: 260px;
            background-color: #0f172a;
            color: #fff;
            position: fixed;
            top: 0; left: 0; bottom: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            z-index: 1000;
        }

        .sidebar-logo {
            font-size: 1.5rem; font-weight: 700; color: #38bdf8;
            margin-bottom: 40px; padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center; gap: 10px;
        }

        .nav-links { list-style: none; flex: 1; }
        .nav-item { margin-bottom: 10px; }
        .nav-link {
            display: flex; align-items: center; gap: 12px;
            padding: 12px 15px; text-decoration: none;
            color: #94a3b8; border-radius: 8px; transition: 0.3s;
            font-size: 0.95rem; font-weight: 500;
        }
        .nav-link:hover, .nav-link.active {
            background-color: rgba(255,255,255,0.1); color: #fff;
        }
        .btn-logout {
            margin-top: auto; color: #ef4444; cursor: pointer; background: none; border: none; width: 100%;
        }
        .btn-logout:hover { background-color: rgba(239, 68, 68, 0.1); }

        /* Main Content (O'ng tomon) */
        .main-content {
            flex: 1;
            margin-left: 260px; /* Sidebar kengligi qadar suramiz */
            padding: 30px;
            width: calc(100% - 260px);
        }

        .header-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px;
        }
        .user-info { text-align: right; }
        .user-name { font-weight: 700; font-size: 1.1rem; }
        .user-role { font-size: 0.85rem; color: #64748b; }

        /* Kartalar */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .card {
            background: white; padding: 25px; border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            display: flex; justify-content: space-between; align-items: center;
        }
        .card h3 { font-size: 2rem; margin-bottom: 5px; color: #0f172a; }
        .card p { color: #64748b; font-size: 0.9rem; }
        .card-icon { font-size: 2.5rem; opacity: 0.8; }

        /* Grafiklar */
        .charts-container {
            display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px;
        }
        .chart-box {
            background: white; padding: 20px; border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            height: 400px; /* Aniq balandlik */
        }

        /* Jadval */
        .table-box {
            background: white; padding: 25px; border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
            overflow-x: auto;
        }
        .table-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;
        }
        .btn-excel {
            background: #10b981; color: white; padding: 8px 16px;
            border-radius: 6px; text-decoration: none; font-size: 0.9rem; border: none; cursor: pointer;
        }

        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { text-align: left; padding: 15px; border-bottom: 2px solid #f1f5f9; color: #64748b; font-size: 0.85rem; text-transform: uppercase; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
        tr:hover { background-color: #f8fafc; }

        /* Status Select */
        .status-select {
            padding: 5px 10px; border-radius: 20px; border: 1px solid #cbd5e1;
            font-size: 0.8rem; font-weight: 600; cursor: pointer; outline: none;
        }
        .status-select.Yangi { background: #fffbeb; color: #d97706; border-color: #fcd34d; }
        .status-select.Hal { background: #dcfce7; color: #166534; border-color: #86efac; }
        .status-select.Rad { background: #fee2e2; color: #991b1b; border-color: #fca5a5; }

        /* Delete Btn */
        .btn-delete {
            width: 32px; height: 32px; border-radius: 6px; border: none;
            background: #fee2e2; color: #ef4444; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-delete:hover { background: #ef4444; color: white; }

        /* Toast */
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
        .toast {
            background: white; border-left: 5px solid #10b981; padding: 15px 20px;
            margin-bottom: 10px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex; align-items: center; gap: 15px; min-width: 300px; animation: slideIn 0.3s forwards;
        }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

        /* Mobil */
        @media (max-width: 992px) {
            .sidebar { width: 70px; padding: 10px; align-items: center; }
            .sidebar-logo span, .nav-link span, .user-role { display: none; }
            .main-content { margin-left: 70px; width: calc(100% - 70px); padding: 15px; }
            .charts-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div class="toast-container" id="toastBox"></div>

    <div class="admin-wrapper">
        <aside class="sidebar">
            <div class="sidebar-logo">
                üõ°Ô∏è <span>NIGOH ADMIN</span>
            </div>
            <ul class="nav-links">
                <li class="nav-item">
                    <a href="#" class="nav-link active">üìä <span>Dashboard</span></a>
                </li>
                <li class="nav-item">
                    <a href="index.html" class="nav-link">üè† <span>Saytga qaytish</span></a>
                </li>
            </ul>
            <button id="logoutBtn" class="nav-link btn-logout">üö™ <span>Chiqish</span></button>
        </aside>

        <main class="main-content">
            <div class="header-bar">
                <h1 style="font-size: 1.5rem;">Boshqaruv Paneli</h1>
                <div class="user-info">
                    <div class="user-name" id="adminName">Admin</div>
                    <div class="user-role" id="adminEmail">Yuklanmoqda...</div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="card">
                    <div><h3 id="totalCount">0</h3><p>Jami Murojaatlar</p></div>
                    <div class="card-icon">üì®</div>
                </div>
                <div class="card">
                    <div><h3 id="solvedCount" style="color:#10b981;">0</h3><p>Hal Etilgan</p></div>
                    <div class="card-icon" style="color:#10b981;">‚úÖ</div>
                </div>
                <div class="card">
                    <div><h3 id="pendingCount" style="color:#f59e0b;">0</h3><p>Jarayonda</p></div>
                    <div class="card-icon" style="color:#f59e0b;">‚è≥</div>
                </div>
                <div class="card">
                    <div><h3 id="rejectedCount" style="color:#ef4444;">0</h3><p>Rad Etilgan</p></div>
                    <div class="card-icon" style="color:#ef4444;">üö´</div>
                </div>
            </div>

            <div class="charts-container">
                <div class="chart-box">
                    <h4 style="margin-bottom: 15px;">Murojaat Turlari</h4>
                    <canvas id="barChart"></canvas>
                </div>
                <div class="chart-box">
                    <h4 style="margin-bottom: 15px;">Statuslar</h4>
                    <canvas id="doughnutChart" style="max-height: 250px;"></canvas>
                </div>
            </div>

            <div class="table-box">
                <div class="table-header">
                    <h3>Oxirgi Murojaatlar</h3>
                    <button class="btn-excel" onclick="window.exportToExcel()">üì• Excelga Yuklash</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Sana</th>
                            <th>Foydalanuvchi</th>
                            <th>Turi & Manzil</th>
                            <th>Lokatsiya</th>
                            <th>Status (Tahrirlash)</th>
                            <th>O'chirish</th>
                        </tr>
                    </thead>
                    <tbody id="reportsTableBody">
                        <tr><td colspan="6" style="text-align:center; padding:20px;">Yuklanmoqda...</td></tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <script type="module">
        import { auth, db, collection, getDocs, doc, updateDoc, deleteDoc, onAuthStateChanged, signOut } from './firebase-config.js';

        const ALLOWED_ADMIN_EMAIL = "islomovjavohir939@gmail.com"; 
        let allReportsData = [];

        function showToast(title, message, type = 'success') {
            const box = document.getElementById('toastBox');
            const toast = document.createElement('div');
            let borderColor = type === 'success' ? '#10b981' : '#ef4444';
            let icon = type === 'success' ? '‚úÖ' : '‚ö†Ô∏è';
            toast.className = 'toast';
            toast.style.borderLeftColor = borderColor;
            toast.innerHTML = `<div style="font-size:1.2rem;">${icon}</div><div><h4 style="margin:0; font-size:0.9rem;">${title}</h4><p style="margin:0; font-size:0.8rem; color:#666;">${message}</p></div>`;
            box.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                if (user.email !== ALLOWED_ADMIN_EMAIL) {
                    alert("Siz Admin emassiz!");
                    window.location.href = "index.html";
                } else {
                    document.getElementById('adminName').innerText = user.displayName || "Admin";
                    document.getElementById('adminEmail').innerText = user.email;
                    loadData();
                }
            } else {
                window.location.href = "login.html";
            }
        });

        async function loadData() {
            try {
                const querySnapshot = await getDocs(collection(db, "reports"));
                let total = 0, solved = 0, pending = 0, rejected = 0;
                let categories = { "pora": 0, "infratuzilma": 0, "vakolat": 0, "ogrilik": 0 };
                let html = "";
                allReportsData = [];

                let reports = [];
                querySnapshot.forEach(doc => {
                    let data = doc.data();
                    data.id = doc.id;
                    reports.push(data);
                });
                reports.reverse();

                reports.forEach(data => {
                    total++;
                    allReportsData.push(data);
                    if (data.status === "Hal etildi") solved++;
                    else if (data.status === "Rad etildi") rejected++;
                    else pending++;

                    if (categories[data.type] !== undefined) categories[data.type]++;

                    let mapBtn = `<span style="color:#ccc;">-</span>`;
                    if (data.latitude && data.longitude) {
                        mapBtn = `<a href="https://www.google.com/maps?q=${data.latitude},${data.longitude}" target="_blank" style="color:#38bdf8; text-decoration:none; font-weight:bold;">üìç Xarita</a>`;
                    }

                    let statusClass = "Yangi";
                    if(data.status.includes("Hal")) statusClass = "Hal";
                    if(data.status.includes("Rad")) statusClass = "Rad";

                    html += `
                        <tr>
                            <td>${data.date.split(',')[0]}</td>
                            <td><b>${data.email.split('@')[0]}</b></td>
                            <td><span style="background:#f1f5f9; padding:2px 5px; border-radius:4px; font-size:0.8rem; text-transform:uppercase;">${data.type}</span><br>${data.address}</td>
                            <td>${mapBtn}</td>
                            <td>
                                <select onchange="window.updateStatus('${data.id}', this.value)" class="status-select ${statusClass}">
                                    <option value="Yangi" ${data.status === 'Yangi' ? 'selected' : ''}>‚è≥ Yangi</option>
                                    <option value="Hal etildi" ${data.status === 'Hal etildi' ? 'selected' : ''}>‚úÖ Hal etildi</option>
                                    <option value="Rad etildi" ${data.status === 'Rad etildi' ? 'selected' : ''}>üö´ Rad etildi</option>
                                </select>
                            </td>
                            <td><button onclick="window.deleteReport('${data.id}')" class="btn-delete">üóëÔ∏è</button></td>
                        </tr>
                    `;
                });

                document.getElementById('totalCount').innerText = total;
                document.getElementById('solvedCount').innerText = solved;
                document.getElementById('pendingCount').innerText = pending;
                document.getElementById('rejectedCount').innerText = rejected;
                document.getElementById('reportsTableBody').innerHTML = html;

                drawCharts(categories, [solved, pending, rejected]);

            } catch (error) {
                console.error(error);
            }
        }

        window.updateStatus = async (docId, newStatus) => {
            try {
                await updateDoc(doc(db, "reports", docId), { status: newStatus });
                showToast("Muvaffaqiyatli", "Status o'zgartirildi!");
                loadData();
            } catch (error) { showToast("Xato", error.message, "error"); }
        };

        window.deleteReport = async (docId) => {
            if (confirm("O'chirilsinmi?")) {
                try {
                    await deleteDoc(doc(db, "reports", docId));
                    showToast("O'chirildi", "Ma'lumot o'chirib tashlandi.");
                    loadData();
                } catch (error) { showToast("Xato", error.message, "error"); }
            }
        };

        window.exportToExcel = () => {
            if(allReportsData.length === 0) return alert("Ma'lumot yo'q");
            const worksheet = XLSX.utils.json_to_sheet(allReportsData);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Hisobot");
            XLSX.writeFile(workbook, `Nigoh_Hisobot.xlsx`);
        };

        let chartInstance1 = null, chartInstance2 = null;
        function drawCharts(catData, statusData) {
            const ctx1 = document.getElementById('barChart');
            const ctx2 = document.getElementById('doughnutChart');
            if (chartInstance1) chartInstance1.destroy();
            if (chartInstance2) chartInstance2.destroy();

            chartInstance1 = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: ['Pora', 'Infratuzilma', 'Vakolat', 'O\'g\'rilik'],
                    datasets: [{
                        label: 'Soni',
                        data: [catData.pora, catData.infratuzilma, catData.vakolat, catData.ogrilik],
                        backgroundColor: ['#3b82f6', '#f59e0b', '#8b5cf6', '#ef4444'],
                        borderRadius: 5
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            chartInstance2 = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: ['Hal etildi', 'Jarayonda', 'Rad etildi'],
                    datasets: [{
                        data: statusData,
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        document.getElementById('logoutBtn').addEventListener('click', () => {
            signOut(auth).then(() => window.location.href = "login.html");
        });
    </script>
</body>
</html>