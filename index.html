<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nigoh | Jamoatchilik Nazorati</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    
    <link rel="stylesheet" href="style.css">

    <style>
        /* INDEX SPECIFIC STYLES */
        
        /* 3D FLOATING CARD ANIMATION */
        .hero-visual {
            perspective: 1000px;
        }
        .glass-card-3d {
            width: 320px;
            padding: 30px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.02));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            transform-style: preserve-3d;
            animation: floatCard 6s ease-in-out infinite;
            position: relative;
        }
        
        @keyframes floatCard {
            0%, 100% { transform: translateY(0) rotateX(0) rotateY(0); }
            50% { transform: translateY(-20px) rotateX(5deg) rotateY(-5deg); }
        }

        .card-icon-lg {
            font-size: 3.5rem;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
        }

        /* HERO STATS (Kichik statistika) */
        .hero-stats {
            display: flex; gap: 20px; margin-top: 40px;
        }
        .mini-stat {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px 25px; border-radius: 16px;
            border: 1px solid var(--border-color);
            backdrop-filter: blur(5px);
        }
        .mini-stat h3 { font-size: 1.5rem; color: white; margin: 0; line-height: 1; }
        .mini-stat p { font-size: 0.85rem; color: var(--text-muted); margin: 5px 0 0 0; }

        /* MAP SECTION */
        #map {
            height: 100%; width: 100%; border-radius: 24px;
            z-index: 1;
        }
        
        /* FILE UPLOAD STYLE */
        .file-upload-box {
            border: 2px dashed var(--border-color);
            padding: 20px; border-radius: 12px;
            text-align: center; cursor: pointer;
            transition: var(--transition);
            background: rgba(0,0,0,0.2);
        }
        .file-upload-box:hover {
            border-color: var(--primary);
            background: rgba(59, 130, 246, 0.1);
        }
        .file-icon { font-size: 1.5rem; color: var(--text-muted); margin-bottom: 8px; }
        .file-text { font-size: 0.9rem; color: var(--text-muted); }

        @media (max-width: 768px) {
            .hero-stats { justify-content: center; }
            .glass-card-3d { width: 100%; max-width: 300px; margin: 0 auto; }
        }
    </style>
</head>
<body>

    <div class="background-shapes">
        <div class="shape shape-1"></div>
        <div class="shape shape-2"></div>
        <div class="shape shape-3"></div>
    </div>

    <div class="toast-container" id="toastBox"></div>

    <header class="glass-header">
        <div class="logo">
            <i class="fa-solid fa-shield-halved" style="color:var(--primary)"></i>
            <span>NIGOH</span>
        </div>
        <nav>
            <ul>
                <li><a href="#" class="nav-link active">Asosiy</a></li>
                <li><a href="profile.html" class="nav-link">Profil</a></li>
                <li><a href="login.html" class="nav-link btn-login" id="authBtn">Kirish</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section class="hero">
            <div class="hero-content">
                <div class="badge-new" style="display:inline-block; margin-bottom:15px; padding:6px 15px; border-radius:20px; font-size:0.85rem;">
                    üöÄ Jamoatchilik nazorati 2.0
                </div>
                <h1>Haqiqatga <br><span>Tik Boq</span></h1>
                <p>Korrupsiya, infratuzilma va qonunbuzarlik holatlarini anonim tarzda xabar bering. Biz sizning ovozingizni tegishli joyga yetkazamiz.</p>
                
                <div class="hero-buttons">
                    <button class="btn-primary" id="openModalBtn">
                        Xabar Berish <i class="fa-solid fa-paper-plane"></i>
                    </button>
                    <button class="btn-secondary" onclick="document.getElementById('mapSection').scrollIntoView({behavior: 'smooth'})">
                        <i class="fa-solid fa-map"></i> Xaritani Ko'rish
                    </button>
                </div>

                <div class="hero-stats">
                    <div class="mini-stat">
                        <h3 id="statTotal">0+</h3>
                        <p>Xabarlar</p>
                    </div>
                    <div class="mini-stat">
                        <h3 id="statSolved" style="color:var(--success)">0%</h3>
                        <p>Hal etildi</p>
                    </div>
                    <div class="mini-stat">
                        <h3>24/7</h3>
                        <p>Monitoring</p>
                    </div>
                </div>
            </div>

            <div class="hero-visual">
                <div class="glass-card-3d">
                    <div class="card-icon-lg"><i class="fa-solid fa-eye"></i></div>
                    <h3 style="color:white; margin-bottom:10px;">Shaffof Tizim</h3>
                    <p style="color:var(--text-muted); font-size:0.9rem; line-height:1.5;">Har bir murojaat blokcheyn kabi himoyalangan va to'g'ridan-to'g'ri mas'ullarga yetkaziladi.</p>
                    
                    <div style="margin-top:20px; display:flex; align-items:center; gap:10px;">
                        <div style="width:40px; height:40px; background:rgba(255,255,255,0.1); border-radius:50%; display:flex; align-items:center; justify-content:center;">üõ°Ô∏è</div>
                        <div style="font-size:0.8rem; color:white;">
                            <div>100% Anonimlik</div>
                            <div style="color:var(--success)">Kafolatlangan</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="map-section" id="mapSection">
            <h2 class="auth-title" style="text-align:center; font-size:2rem; margin-bottom:10px;">Muammolar Xaritasi</h2>
            <p style="text-align:center; color:var(--text-muted); margin-bottom:30px;">Real vaqt rejimida kelib tushayotgan murojaatlar va ularning holati.</p>
            
            <div class="map-container-glass">
                <div id="map"></div>
                <div style="position:absolute; bottom:20px; left:20px; z-index:400; background:var(--panel-bg); padding:10px; border-radius:10px; border:1px solid var(--border-color); font-size:0.8rem; color:white;">
                    <div style="display:flex; align-items:center; gap:5px; margin-bottom:5px;"><span style="width:10px; height:10px; background:#ef4444; border-radius:50%;"></span> Yangi / Muammo</div>
                    <div style="display:flex; align-items:center; gap:5px;"><span style="width:10px; height:10px; background:#10b981; border-radius:50%;"></span> Hal etilgan</div>
                </div>
            </div>
        </section>
    </main>

    <footer class="glass-footer">
        <div class="footer-content">
            <div class="footer-col brand-col">
                <div class="logo"><i class="fa-solid fa-shield-halved" style="color:var(--primary)"></i> NIGOH</div>
                <p style="margin-top:15px; color:var(--text-muted); font-size:0.9rem;">
                    Korrupsiyaga qarshi kurashish va shaffoflikni ta'minlash uchun xalqchil platforma.
                </p>
            </div>
            
            <div class="footer-col">
                <h4 style="color:white; margin-bottom:15px;">Platforma</h4>
                <a href="#">Loyiha haqida</a>
                <a href="#">Qo'llanma</a>
                <a href="admin.html">Admin Panel</a>
            </div>

            <div class="footer-col">
                <h4 style="color:white; margin-bottom:15px;">Bog'lanish</h4>
                <a href="#"><i class="fa-solid fa-location-dot"></i> Samarqand, Urgut</a>
                <a href="#"><i class="fa-solid fa-phone"></i> +998 93 107 88 16</a>
                <a href="#"><i class="fa-brands fa-telegram"></i> @nigoh_bot</a>
            </div>
        </div>
        <div class="footer-bottom">
            <p>¬© 2026 Nigoh Loyihasi. Barcha huquqlar himoyalangan.</p>
        </div>
    </footer>

    <div class="modal-overlay" id="reportModal">
        <div class="modal-content">
            <i class="fa-solid fa-xmark" id="closeModal" style="position:absolute; top:20px; right:20px; font-size:1.5rem; cursor:pointer; color:var(--text-muted);"></i>
            
            <h2 style="color:white; margin-bottom:5px;">Muammo haqida xabar</h2>
            <p style="color:var(--text-muted); font-size:0.9rem; margin-bottom:20px;">Ma'lumotlar anonim qoladi.</p>
            
            <form id="reportForm">
                <div class="input-group">
                    <label>Muammo turi</label>
                    <select id="type" required>
                        <option value="" disabled selected>Tanlang...</option>
                        <option value="Pora olish/berish">üí∞ Pora olish/berish</option>
                        <option value="Infratuzilma">üèóÔ∏è Infratuzilma (Yo'l, Gaz, Svet)</option>
                        <option value="Vakolat suiiste'moli">üëÆ Vakolatni suiiste'mol qilish</option>
                        <option value="O'g'rilik">üö´ O'g'rilik va Jinoyat</option>
                        <option value="Ekologiya">üå≥ Ekologiya buzilishi</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Manzil</label>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="address" placeholder="Mo'ljal yoki manzil..." required style="margin-bottom:0;">
                        <button type="button" id="geoBtn" class="btn-secondary" style="padding:10px 15px;" title="Joylashuvimni olish">
                            <i class="fa-solid fa-location-crosshairs"></i>
                        </button>
                    </div>
                    <input type="hidden" id="lat">
                    <input type="hidden" id="lng">
                    <small id="geoStatus" style="color:var(--success); font-size:0.8rem; display:none; margin-top:5px;">
                        <i class="fa-solid fa-check"></i> Joylashuv aniqlandi!
                    </small>
                </div>

                <div class="input-group">
                    <label>Batafsil ma'lumot</label>
                    <textarea id="desc" rows="3" placeholder="Muammo haqida qisqacha yozing..." required></textarea>
                </div>

                <div class="input-group">
                    <label>Isbot (Rasm/Video)</label>
                    <div class="file-upload-box" onclick="document.getElementById('fileInput').click()">
                        <div class="file-icon"><i class="fa-solid fa-cloud-arrow-up"></i></div>
                        <div class="file-text" id="fileName">Faylni tanlash (Ixtiyoriy)</div>
                        <input type="file" id="fileInput" hidden accept="image/*,video/*">
                    </div>
                </div>

                <button type="submit" class="btn-primary full-width" id="submitBtn">
                    YUBORISH <i class="fa-solid fa-paper-plane" style="margin-left:5px;"></i>
                </button>
            </form>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

    <script type="module">
        import { auth, db, addDoc, collection, onAuthStateChanged, getDocs, signOut } from './firebase-config.js';

        // --- GLOBAL VARS ---
        let map;
        let currentUser = null;

        // --- AUTH CHECK ---
        const authBtn = document.getElementById('authBtn');
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                authBtn.innerText = "Chiqish";
                authBtn.style.borderColor = "var(--danger)";
                authBtn.style.color = "var(--danger)";
                authBtn.href = "#";
                authBtn.onclick = (e) => {
                    e.preventDefault();
                    if(confirm("Tizimdan chiqmoqchimisiz?")) {
                        signOut(auth).then(() => window.location.reload());
                    }
                };
            } else {
                authBtn.innerText = "Kirish";
                authBtn.href = "login.html";
            }
        });

        // --- MAP INITIALIZATION ---
        function initMap() {
            // Urgut coordinates default
            map = L.map('map').setView([39.4056, 67.2430], 12);
            
            // Dark Theme Tiles
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { 
                attribution: '&copy; OpenStreetMap & CARTO',
                maxZoom: 19
            }).addTo(map);

            loadMapData();
        }

        // --- LOAD DATA FOR MAP & STATS ---
        async function loadMapData() {
            try {
                const querySnapshot = await getDocs(collection(db, "reports"));
                let heatData = [];
                let total = 0;
                let solved = 0;

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    total++;
                    if(data.status === "Hal etildi") solved++;

                    if (data.latitude && data.longitude) {
                        // Heatmap Data
                        heatData.push([data.latitude, data.longitude, 0.6]);

                        // Markers
                        let color = data.status === "Hal etildi" ? "#10b981" : "#ef4444";
                        
                        const marker = L.circleMarker([data.latitude, data.longitude], {
                            radius: 6,
                            fillColor: color,
                            color: "#fff",
                            weight: 1,
                            opacity: 1,
                            fillOpacity: 0.8
                        }).addTo(map);

                        marker.bindPopup(`
                            <div style="font-family:'Inter',sans-serif; min-width:150px;">
                                <b style="color:${color}">${data.type}</b><br>
                                <span style="font-size:0.85rem; color:#333;">${data.description}</span><br>
                                <small style="color:#666;">${data.date.split(',')[0]}</small>
                            </div>
                        `);
                    }
                });

                // Add Heatmap Layer
                if (heatData.length > 0) {
                    L.heatLayer(heatData, { radius: 25, blur: 15, maxZoom: 17 }).addTo(map);
                }

                // Update Stats UI
                animateValue("statTotal", 0, total, 1000);
                const percent = total > 0 ? Math.round((solved / total) * 100) : 0;
                document.getElementById('statSolved').innerText = percent + "%";

            } catch (error) {
                console.error("Map Data Error:", error);
            }
        }

        // --- ANIMATE NUMBERS ---
        function animateValue(id, start, end, duration) {
            if (start === end) return;
            const range = end - start;
            let current = start;
            const increment = end > start ? 1 : -1;
            const stepTime = Math.abs(Math.floor(duration / range));
            const obj = document.getElementById(id);
            const timer = setInterval(() => {
                current += increment;
                obj.innerHTML = current + "+";
                if (current == end) clearInterval(timer);
            }, stepTime);
        }

        // --- GPS LOGIC ---
        const geoBtn = document.getElementById('geoBtn');
        const geoStatus = document.getElementById('geoStatus');
        
        geoBtn.addEventListener('click', () => {
            if (navigator.geolocation) {
                geoBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        document.getElementById('lat').value = lat;
                        document.getElementById('lng').value = lng;
                        
                        const addrInput = document.getElementById('address');
                        if(!addrInput.value) {
                            addrInput.value = `GPS Lokatsiya (${lat.toFixed(4)}, ${lng.toFixed(4)})`;
                        }

                        geoBtn.innerHTML = '<i class="fa-solid fa-check"></i>';
                        geoBtn.style.background = 'var(--success)';
                        geoBtn.style.borderColor = 'var(--success)';
                        geoStatus.style.display = 'block';
                        showToast("Topildi", "Joylashuvingiz aniqlandi!", "success");
                    },
                    (error) => {
                        geoBtn.innerHTML = '<i class="fa-solid fa-location-crosshairs"></i>';
                        showToast("Xatolik", "GPS ga ruxsat bering yoki yoqing.", "error");
                    }
                );
            } else {
                showToast("Xatolik", "Brauzeringiz GPS ni qo'llamaydi.", "error");
            }
        });

        // --- FILE INPUT UI ---
        document.getElementById('fileInput').addEventListener('change', function() {
            if(this.files.length > 0) {
                document.getElementById('fileName').innerText = "Tanlandi: " + this.files[0].name;
                document.getElementById('fileName').style.color = "var(--primary)";
                document.querySelector('.file-icon').style.color = "var(--primary)";
                document.querySelector('.file-upload-box').style.borderColor = "var(--primary)";
            }
        });

        // --- MODAL CONTROLS ---
        const modal = document.getElementById('reportModal');
        const openBtn = document.getElementById('openModalBtn');
        const closeBtn = document.getElementById('closeModal');

        openBtn.onclick = () => {
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('show'), 10);
        };
        
        closeBtn.onclick = () => {
            modal.classList.remove('show');
            setTimeout(() => modal.style.display = 'none', 300);
        };

        // --- FORM SUBMISSION ---
        document.getElementById('reportForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentUser) {
                showToast("Diqqat", "Xabar yuborish uchun tizimga kiring!", "warning");
                setTimeout(() => window.location.href = "login.html", 1500);
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            const originalBtnContent = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Yuborilmoqda...';
            submitBtn.disabled = true;

            const type = document.getElementById('type').value;
            const address = document.getElementById('address').value;
            const desc = document.getElementById('desc').value;
            const lat = document.getElementById('lat').value;
            const lng = document.getElementById('lng').value;
            const file = document.getElementById('fileInput').files[0];

            try {
                // 1. Save to Firebase
                const docRef = await addDoc(collection(db, "reports"), {
                    uid: currentUser.uid,
                    email: currentUser.email,
                    type: type,
                    address: address,
                    description: desc,
                    status: "Yangi",
                    latitude: lat ? parseFloat(lat) : null,
                    longitude: lng ? parseFloat(lng) : null,
                    date: new Date().toLocaleString('uz-UZ'),
                    timestamp: new Date()
                });

                // 2. Send to Telegram (via Backend)
                const formData = new FormData();
                formData.append('docId', docRef.id);
                formData.append('type', type);
                formData.append('address', address);
                formData.append('desc', desc);
                formData.append('email', currentUser.email);
                formData.append('name', currentUser.displayName || "Foydalanuvchi");
                if(lat) formData.append('lat', lat);
                if(lng) formData.append('lng', lng);
                if(file) formData.append('document', file);

                // Use your Render URL here
                await fetch("https://nigoh-bot.onrender.com/send-report", {
                    method: 'POST',
                    body: formData
                });

                showToast("Muvaffaqiyatli", "Xabaringiz adminga yuborildi!", "success");
                
                // Cleanup
                document.getElementById('reportForm').reset();
                document.getElementById('fileName').innerText = "Faylni tanlash (Ixtiyoriy)";
                document.getElementById('geoStatus').style.display = 'none';
                geoBtn.style.background = '';
                geoBtn.innerHTML = '<i class="fa-solid fa-location-crosshairs"></i>';
                
                modal.classList.remove('show');
                setTimeout(() => modal.style.display = 'none', 300);
                
                // Refresh Map
                initMap();

            } catch (error) {
                console.error(error);
                showToast("Xatolik", "Serverga ulanishda xato: " + error.message, "error");
            } finally {
                submitBtn.innerHTML = originalBtnContent;
                submitBtn.disabled = false;
            }
        });

        // --- TOAST FUNCTION ---
        function showToast(title, message, type) {
            const box = document.getElementById('toastBox');
            const toast = document.createElement('div');
            let color = type === 'success' ? 'var(--success)' : (type === 'error' ? 'var(--danger)' : 'var(--warning)');
            let icon = type === 'success' ? '<i class="fa-solid fa-check"></i>' : (type === 'error' ? '<i class="fa-solid fa-triangle-exclamation"></i>' : '<i class="fa-solid fa-info"></i>');

            toast.className = 'toast';
            toast.style.borderColor = color;
            toast.innerHTML = `
                <div style="font-size:1.5rem; color:${color}">${icon}</div>
                <div>
                    <h4 style="margin:0; font-size:0.95rem;">${title}</h4>
                    <p style="margin:2px 0 0; font-size:0.85rem; opacity:0.8">${message}</p>
                </div>
            `;
            box.appendChild(toast);
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.4s reverse forwards';
                setTimeout(() => toast.remove(), 400);
            }, 3000);
        }

        // --- INIT APP ---
        window.addEventListener('load', initMap);

    </script>
</body>
</html>